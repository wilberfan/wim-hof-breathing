<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="theme-color" content="#050a0f">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Wim Hof">
<title>Wim Hof Breathing</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
/* ============================================================
   ROOT & RESET
   ============================================================ */
:root {
  --bg: #050a0f;
  --surface: #0a1520;
  --surface2: #0f1e2e;
  --surface3: #162436;
  --accent: #00c9ff;
  --accent2: #005e8a;
  --accent3: #003d5c;
  --warm: #ff6b35;
  --warm2: #8a3510;
  --cold: #00c9ff;
  --text: #c8dde8;
  --text-dim: #4a6b80;
  --text-mid: #7aabb8;
  --border: #1a3348;
  --border2: #0f2233;
  --glow: rgba(0,201,255,0.18);
  --glow-warm: rgba(255,107,53,0.18);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --nav-height: 68px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  user-select: none;
  touch-action: pan-y;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 15% 40%, rgba(0,100,160,0.1) 0%, transparent 55%),
    radial-gradient(ellipse at 85% 15%, rgba(0,201,255,0.06) 0%, transparent 45%);
  pointer-events: none;
  z-index: 0;
}

/* ============================================================
   APP SHELL
   ============================================================ */
#app {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  z-index: 1;
  padding-top: var(--safe-top);
  padding-bottom: var(--safe-bottom);
}

/* ============================================================
   HEADER
   ============================================================ */
#app-header {
  flex-shrink: 0;
  padding: 12px 20px 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border2);
  background: rgba(5,10,15,0.95);
  backdrop-filter: blur(12px);
}

.app-title {
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--accent);
  text-shadow: 0 0 20px rgba(0,201,255,0.35);
  line-height: 1;
}

.app-subtitle {
  font-size: 0.6rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 2px;
}

.header-btn {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 1.4rem;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  line-height: 1;
  transition: color 0.2s;
}
.header-btn:active { color: var(--accent); }

.blank-icon-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  font-size: 0.55rem;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 700;
  letter-spacing: 0.12em;
  color: var(--text-dim);
  padding: 6px 8px;
}
.blank-icon-btn:active { color: var(--accent); }

.blank-icon {
  display: block;
  width: 20px;
  height: 20px;
  background: var(--text-dim);
  border-radius: 3px;
  transition: background 0.2s;
}
.blank-icon-btn:active .blank-icon { background: var(--accent); }

/* ============================================================
   SCROLL AREA
   ============================================================ */
#scroll-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

/* ============================================================
   BOTTOM NAV
   ============================================================ */
#bottom-nav {
  flex-shrink: 0;
  display: flex;
  background: rgba(10,21,32,0.97);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(12px);
}

.nav-btn {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 10px 4px 6px;
  border: none;
  background: none;
  color: var(--text-dim);
  cursor: pointer;
  transition: color 0.2s;
  gap: 3px;
  min-height: var(--nav-height);
}

.nav-btn.active { color: var(--accent); }
.nav-btn:active { opacity: 0.7; }

.nav-icon { font-size: 1.4rem; line-height: 1; }
.nav-label {
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.65rem;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

/* ============================================================
   PANELS
   ============================================================ */
.panel {
  display: none;
  padding: 16px;
  padding-bottom: 24px;
}
.panel.active { display: block; }

/* ============================================================
   SECTION CARDS
   ============================================================ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  position: relative;
  overflow: hidden;
}

.card-accent {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 3px;
  background: linear-gradient(90deg, var(--accent2), transparent);
}

.card-label {
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 14px;
}

/* ============================================================
   SPINNER CONTROL ‚Äî large touch targets
   ============================================================ */
.spinner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.spin-btn {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 1.5px solid var(--accent2);
  background: var(--surface2);
  color: var(--accent);
  font-size: 1.6rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  flex-shrink: 0;
  line-height: 1;
}
.spin-btn:active { background: var(--accent2); transform: scale(0.94); }

.spin-val {
  font-family: 'Share Tech Mono', monospace;
  font-size: 2.4rem;
  color: var(--accent);
  text-align: center;
  flex: 1;
  line-height: 1;
}
.spin-unit {
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dim);
  text-align: center;
  margin-top: 3px;
}

/* Quick-set chips */
.chips {
  display: flex;
  gap: 6px;
  justify-content: center;
  margin-top: 12px;
  flex-wrap: wrap;
}

.chip {
  padding: 6px 14px;
  border: 1px solid var(--border);
  border-radius: 20px;
  background: var(--surface2);
  color: var(--text-mid);
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}
.chip:active, .chip.active {
  background: var(--accent3);
  border-color: var(--accent2);
  color: var(--accent);
}

/* ============================================================
   SEGMENTED CONTROL
   ============================================================ */
.segmented {
  display: flex;
  background: var(--surface2);
  border-radius: 10px;
  padding: 3px;
  gap: 2px;
}

.seg-btn {
  flex: 1;
  padding: 11px 6px;
  border: none;
  background: none;
  color: var(--text-dim);
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
}
.seg-btn.active {
  background: var(--accent2);
  color: var(--accent);
  box-shadow: inset 0 0 0 1px rgba(0,201,255,0.2);
}
.seg-btn:active { opacity: 0.7; }

/* ============================================================
   TOGGLE ROW
   ============================================================ */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 4px 0;
}

.toggle-text {
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  color: var(--text);
  flex: 1;
  line-height: 1.3;
}
.toggle-text small {
  display: block;
  font-size: 0.7rem;
  color: var(--text-dim);
  font-weight: 400;
  margin-top: 2px;
  letter-spacing: 0.04em;
}

.toggle {
  position: relative;
  width: 50px;
  height: 28px;
  flex-shrink: 0;
}
.toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--surface3);
  border-radius: 28px;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: 0.25s;
}
.toggle-slider::before {
  content: '';
  position: absolute;
  width: 20px; height: 20px;
  left: 3px; top: 3px;
  background: var(--text-dim);
  border-radius: 50%;
  transition: 0.25s;
}
input:checked + .toggle-slider { background: var(--accent2); border-color: var(--accent); }
input:checked + .toggle-slider::before { transform: translateX(22px); background: var(--accent); }

/* Divider */
.divider {
  height: 1px;
  background: var(--border2);
  margin: 10px 0;
}

/* Checkbox group */
.check-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  margin-top: 8px;
}

.check-row {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px 10px;
  background: var(--surface2);
  border-radius: 8px;
  border: 1px solid var(--border2);
  transition: border-color 0.15s;
}
.check-row:active { border-color: var(--accent2); }

.check-row input[type=checkbox] {
  accent-color: var(--accent);
  width: 18px; height: 18px;
  cursor: pointer;
  flex-shrink: 0;
}

.check-label {
  font-size: 0.8rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  color: var(--text-mid);
}

/* ============================================================
   SESSION PANEL
   ============================================================ */
#panel-session {
  padding: 0;
  display: none;
  flex-direction: column;
  height: 100%;
}
#panel-session.active { display: flex; }

/* Pre-start screen */
#pre-start {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 20px;
  gap: 20px;
}

.pre-title {
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text);
  text-align: center;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  width: 100%;
}

.sum-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 8px;
  text-align: center;
}
.sum-val {
  font-family: 'Share Tech Mono', monospace;
  font-size: 1.4rem;
  color: var(--accent);
  display: block;
}
.sum-lbl {
  font-size: 0.58rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 3px;
}

.warning-box {
  background: rgba(255,107,53,0.08);
  border: 1px solid rgba(255,107,53,0.25);
  border-radius: 10px;
  padding: 14px 16px;
  width: 100%;
}
.warning-box p {
  font-size: 0.78rem;
  line-height: 1.65;
  color: var(--warm);
  text-align: center;
}

/* Start button */
.start-btn {
  width: 100%;
  max-width: 300px;
  padding: 18px;
  background: var(--accent);
  border: none;
  border-radius: 14px;
  color: #000;
  font-family: 'Rajdhani', sans-serif;
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  cursor: pointer;
  box-shadow: 0 0 30px rgba(0,201,255,0.25), 0 4px 16px rgba(0,0,0,0.3);
  transition: all 0.2s;
}
.start-btn:active { transform: scale(0.97); box-shadow: 0 0 15px rgba(0,201,255,0.2); }

/* ============================================================
   ACTIVE SESSION
   ============================================================ */
#active-session {
  display: none;
  flex: 1;
  flex-direction: column;
  align-items: center;
  padding: 12px 16px 16px;
  gap: 12px;
  overflow: hidden;
}

/* Phase track */
.phase-track {
  display: flex;
  width: 100%;
  background: var(--surface);
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--border);
}
.phase-seg {
  flex: 1;
  text-align: center;
  padding: 8px 4px;
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-dim);
  border-right: 1px solid var(--border2);
  transition: all 0.3s;
}
.phase-seg:last-child { border-right: none; }
.phase-seg.active-phase { background: var(--accent2); color: var(--accent); }

/* Breath circle */
.circle-wrap {
  position: relative;
  width: min(68vw, 260px);
  height: min(68vw, 260px);
  flex-shrink: 0;
}
.circle-wrap svg { width: 100%; height: 100%; transform: rotate(-90deg); }

.ring-bg { fill: none; stroke: var(--surface2); stroke-width: 10; }
.ring-fg {
  fill: none;
  stroke: var(--accent);
  stroke-width: 10;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.5s linear, stroke 0.4s;
}

.circle-inner {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.ci-phase {
  font-size: 0.6rem;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 4px;
}
.ci-main {
  font-family: 'Share Tech Mono', monospace;
  font-size: clamp(2.5rem, 10vw, 3.5rem);
  color: var(--accent);
  line-height: 1;
}
.ci-sub {
  font-size: 0.65rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 4px;
}

/* Status row */
.status-row {
  display: flex;
  gap: 16px;
  justify-content: center;
  width: 100%;
}
.stat-item { text-align: center; flex: 1; }
.stat-num {
  font-family: 'Share Tech Mono', monospace;
  font-size: 1.6rem;
  color: var(--accent);
  display: block;
  line-height: 1;
}
.stat-lbl {
  font-size: 0.58rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 3px;
}

/* Round dots */
.round-dots {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}
.r-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  border: 1px solid var(--accent2);
  background: transparent;
  transition: all 0.3s;
}
.r-dot.done { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.r-dot.curr { background: var(--warm); border-color: var(--warm); box-shadow: 0 0 8px var(--warm); }

/* Session buttons */
.session-btns {
  display: flex;
  gap: 10px;
  width: 100%;
}
.sess-btn {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: none;
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
}
.sess-btn:active { transform: scale(0.96); }
.sess-pause { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.sess-stop { background: rgba(255,107,53,0.15); border: 1px solid rgba(255,107,53,0.3); color: var(--warm); }
.sess-blank { background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim); font-size: 0.75rem; }

/* ============================================================
   COMPLETE SCREEN
   ============================================================ */
#complete-screen {
  display: none;
  flex: 1;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px 20px;
  gap: 20px;
}

.complete-title {
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--accent);
  text-shadow: 0 0 30px rgba(0,201,255,0.4);
}
.complete-sub { color: var(--text-dim); font-size: 0.85rem; letter-spacing: 0.1em; }

.complete-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  width: 100%;
}
.cstat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 8px;
  text-align: center;
}
.cstat-num {
  font-family: 'Share Tech Mono', monospace;
  font-size: 1.8rem;
  color: var(--accent);
  display: block;
}
.cstat-lbl {
  font-size: 0.58rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 4px;
}

/* ============================================================
   BLANK SCREEN
   ============================================================ */
#blank-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 9999;
  cursor: pointer;
}
#blank-overlay.show { display: flex; align-items: center; justify-content: center; }
#blank-overlay span {
  color: #0a0a0a;
  font-family: 'Share Tech Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.1em;
}

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes breathe-in {
  from { transform: scale(1); }
  to { transform: scale(1.06); }
}
@keyframes breathe-out {
  from { transform: scale(1.06); }
  to { transform: scale(1); }
}
@keyframes hold-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.anim-inhale .circle-wrap { animation: breathe-in 0.4s ease-out forwards; }
.anim-exhale .circle-wrap { animation: breathe-out 0.3s ease-in forwards; }
.anim-hold .ci-main { animation: hold-pulse 2s ease-in-out infinite; }

/* Ripple on circle */
.circle-wrap::after {
  content: '';
  position: absolute;
  inset: -8px;
  border-radius: 50%;
  border: 2px solid transparent;
  transition: border-color 0.3s;
}
.anim-inhale .circle-wrap::after { border-color: rgba(0,201,255,0.15); }

/* Scroll bar */
#scroll-area::-webkit-scrollbar { width: 3px; }
#scroll-area::-webkit-scrollbar-track { background: transparent; }
#scroll-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* Install banner */
#install-banner {
  display: none;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 16px;
  align-items: center;
  gap: 12px;
}
#install-banner.show { display: flex; }
.install-text { flex: 1; font-size: 0.8rem; color: var(--text-mid); line-height: 1.4; }
.install-btn {
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: #000;
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  padding: 8px 14px;
  cursor: pointer;
  white-space: nowrap;
}
.install-dismiss {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 4px;
}

/* ============================================================
   STREAK BANNER
   ============================================================ */
#streak-banner {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
  background: linear-gradient(90deg, rgba(0,60,90,0.7), rgba(0,40,60,0.4));
  border-bottom: 1px solid var(--border);
  gap: 12px;
}
.streak-left { display: flex; align-items: center; gap: 10px; }
.streak-flame {
  font-size: 1.5rem;
  line-height: 1;
  filter: drop-shadow(0 0 6px rgba(255,150,50,0.6));
}
.streak-info { line-height: 1.2; }
.streak-count {
  font-family: 'Share Tech Mono', monospace;
  font-size: 1.3rem;
  color: var(--accent);
  line-height: 1;
}
.streak-count span {
  font-size: 0.68rem;
  font-family: 'Rajdhani', sans-serif;
  font-weight: 700;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--text-mid);
  margin-left: 4px;
}
.streak-label {
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-top: 2px;
}
.streak-right { text-align: right; }
.streak-since {
  font-size: 0.58rem;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  text-transform: uppercase;
}
.streak-date {
  font-family: 'Share Tech Mono', monospace;
  font-size: 0.72rem;
  color: var(--text-mid);
}
#streak-banner.streak-broken {
  background: linear-gradient(90deg, rgba(90,20,0,0.6), rgba(60,10,0,0.3));
  border-bottom-color: rgba(255,107,53,0.3);
}
#streak-banner.streak-broken .streak-count { color: var(--warm); }
#streak-banner.streak-broken .streak-flame { filter: grayscale(0.8) opacity(0.5); }
.streak-log-btn {
  background: var(--accent2);
  border: none;
  border-radius: 8px;
  color: var(--accent);
  font-family: 'Rajdhani', sans-serif;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  padding: 8px 12px;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s;
  flex-shrink: 0;
}
.streak-log-btn:active { transform: scale(0.95); }
.streak-log-btn.logged {
  background: rgba(0,201,255,0.08);
  color: var(--text-dim);
  border: 1px solid var(--border);
  pointer-events: none;
}
</style>
</head>
<body>

<!-- BLANK SCREEN OVERLAY -->
<div id="blank-overlay" onclick="hideBlank()">
  <span>tap to restore</span>
</div>

<!-- APP SHELL -->
<div id="app">

  <!-- HEADER -->
  <div id="app-header">
    <div>
      <div class="app-title">Wim Hof</div>
      <div class="app-subtitle">Breathing Method</div>
    </div>
    <button class="header-btn blank-icon-btn" onclick="showBlank()" title="Blank screen"><span class="blank-icon"></span>BLANK</button>
  </div>

  <!-- INSTALL BANNER -->
  <div id="install-banner">
    <div class="install-text">Add to Home Screen for the full app experience</div>
    <button class="install-btn" id="install-btn">Install</button>
    <button class="install-dismiss" onclick="document.getElementById('install-banner').classList.remove('show')">‚úï</button>
  </div>


  <!-- STREAK BANNER -->
  <div id="streak-banner">
    <div class="streak-left">
      <div class="streak-flame" id="streak-flame">&#128293;</div>
      <div class="streak-info">
        <div class="streak-count" id="streak-count">&#8212;<span>days</span></div>
        <div class="streak-label">Consecutive Streak</div>
      </div>
    </div>
    <div class="streak-right">
      <div class="streak-since">Since</div>
      <div class="streak-date" id="streak-since-date">Oct 31, 2024</div>
    </div>
    <button class="streak-log-btn" id="streak-log-btn" onclick="logTodayManual()">Log Today</button>
  </div>
  <!-- SCROLL AREA -->
  <div id="scroll-area">

    <!-- SETTINGS PANEL -->
    <div id="panel-settings" class="panel active">

      <!-- Breathing -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Breathing</div>

        <div class="card-label" style="margin-bottom:8px;">Number of Breaths</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('breaths',-5)">‚àí</button>
          <div>
            <div class="spin-val" id="val-breaths">30</div>
            <div class="spin-unit">breaths</div>
          </div>
          <button class="spin-btn" onclick="adj('breaths',5)">+</button>
        </div>
        <div class="chips">
          <button class="chip" onclick="quickSet('breaths',20)">20</button>
          <button class="chip" onclick="quickSet('breaths',25)">25</button>
          <button class="chip active" onclick="quickSet('breaths',30)">30</button>
          <button class="chip" onclick="quickSet('breaths',40)">40</button>
        </div>

        <div class="divider"></div>

        <div class="card-label" style="margin-bottom:8px;">Breath Pace</div>
        <div class="segmented">
          <button class="seg-btn" id="pace-slower" onclick="setPace('slower')">Slower</button>
          <button class="seg-btn active" id="pace-regular" onclick="setPace('regular')">Regular</button>
          <button class="seg-btn" id="pace-faster" onclick="setPace('faster')">Faster</button>
        </div>
        <div id="pace-detail" style="text-align:center;margin-top:8px;font-family:'Share Tech Mono',monospace;font-size:0.75rem;color:var(--text-dim);">2.0s inhale ¬∑ 1.5s exhale</div>
      </div>

      <!-- Rounds & Retention -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Rounds & Hold</div>

        <div class="card-label" style="margin-bottom:8px;">Rounds</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('rounds',-1)">‚àí</button>
          <div>
            <div class="spin-val" id="val-rounds">3</div>
            <div class="spin-unit">rounds</div>
          </div>
          <button class="spin-btn" onclick="adj('rounds',1)">+</button>
        </div>

        <div class="divider"></div>

        <div class="card-label" style="margin-bottom:8px;">Retention (Breath Hold)</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('retention',-15)">‚àí</button>
          <div>
            <div class="spin-val" id="val-retention">90</div>
            <div class="spin-unit">seconds</div>
          </div>
          <button class="spin-btn" onclick="adj('retention',15)">+</button>
        </div>
        <div class="chips">
          <button class="chip" onclick="quickSet('retention',60)">60s</button>
          <button class="chip active" onclick="quickSet('retention',90)">90s</button>
          <button class="chip" onclick="quickSet('retention',120)">2min</button>
          <button class="chip" onclick="quickSet('retention',150)">2:30</button>
        </div>

        <div class="divider"></div>

        <div class="card-label" style="margin-bottom:8px;">Increase Hold per Round</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('retentionInc',-5)">‚àí</button>
          <div>
            <div class="spin-val" id="val-retentionInc">0</div>
            <div class="spin-unit">sec/round</div>
          </div>
          <button class="spin-btn" onclick="adj('retentionInc',5)">+</button>
        </div>
      </div>

      <!-- Recovery & Transition -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Recovery & Transition</div>

        <div class="card-label" style="margin-bottom:8px;">Recovery Hold</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('recovery',-5)">‚àí</button>
          <div>
            <div class="spin-val" id="val-recovery">15</div>
            <div class="spin-unit">seconds</div>
          </div>
          <button class="spin-btn" onclick="adj('recovery',5)">+</button>
        </div>

        <div class="divider"></div>

        <div class="card-label" style="margin-bottom:8px;">Round Transition</div>
        <div class="spinner">
          <button class="spin-btn" onclick="adj('transition',-5)">‚àí</button>
          <div>
            <div class="spin-val" id="val-transition">10</div>
            <div class="spin-unit">seconds</div>
          </div>
          <button class="spin-btn" onclick="adj('transition',5)">+</button>
        </div>
      </div>

    </div><!-- /panel-settings -->

    <!-- AUDIO PANEL -->
    <div id="panel-audio" class="panel">

      <!-- Metronome -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Metronome</div>
        <div class="toggle-row">
          <div class="toggle-text">
            Enable Metronome
            <small>Audible beat sets breathing pace</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-metro" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="divider"></div>
        <div class="card-label" style="margin-bottom:8px;">Sound Type</div>
        <div class="segmented">
          <button class="seg-btn active" id="ms-click" onclick="setMetroSound('click')">Click</button>
          <button class="seg-btn" id="ms-heartbeat" onclick="setMetroSound('heartbeat')">Heartbeat</button>
          <button class="seg-btn" id="ms-soft" onclick="setMetroSound('soft')">Soft Tone</button>
        </div>
      </div>

      <!-- Breath Sounds -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Breathing Sounds</div>
        <div class="toggle-row">
          <div class="toggle-text">
            Enable Breath Sounds
            <small>Inhale/exhale audio matched to pace</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-breath" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="divider"></div>
        <div class="segmented">
          <button class="seg-btn active" id="bs-ocean" onclick="setBreathSound('ocean')">Ocean</button>
          <button class="seg-btn" id="bs-wind" onclick="setBreathSound('wind')">Wind</button>
          <button class="seg-btn" id="bs-nose" onclick="setBreathSound('nose')">Nose</button>
        </div>
      </div>

      <!-- Bell -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Breath Hold Bell</div>
        <div class="toggle-row">
          <div class="toggle-text">
            Enable Bell Announcements
            <small>Rings at set intervals during hold</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-bell" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="divider"></div>
        <div class="card-label" style="margin-bottom:6px;">Announce every</div>
        <div class="check-grid">
          <label class="check-row"><input type="checkbox" id="bell-15" checked><span class="check-label">15 seconds</span></label>
          <label class="check-row"><input type="checkbox" id="bell-30" checked><span class="check-label">30 seconds</span></label>
          <label class="check-row"><input type="checkbox" id="bell-60" checked><span class="check-label">60 seconds</span></label>
          <label class="check-row"><input type="checkbox" id="bell-90"><span class="check-label">90 seconds</span></label>
        </div>
      </div>

      <!-- Voice Prompts -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Voice Prompts</div>
        <div class="toggle-row">
          <div class="toggle-text">
            Enable Voice Prompts
            <small>Spoken announcements during session</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-voice" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="divider"></div>
        <div class="check-grid">
          <label class="check-row"><input type="checkbox" id="voice-10" checked><span class="check-label">Last 10 breaths</span></label>
          <label class="check-row"><input type="checkbox" id="voice-3" checked><span class="check-label">Last 3 breaths</span></label>
          <label class="check-row"><input type="checkbox" id="voice-hold" checked><span class="check-label">Start hold</span></label>
          <label class="check-row"><input type="checkbox" id="voice-rec" checked><span class="check-label">Recovery hold</span></label>
        </div>
      </div>

      <!-- Display -->
      <div class="card">
        <div class="card-accent"></div>
        <div class="card-label">Display</div>
        <div class="toggle-row">
          <div class="toggle-text">
            Blank Screen During Session
            <small>Saves battery ‚Äî tap screen to restore</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-blank" onchange="if(this.checked) showBlank(); else hideBlank()"><span class="toggle-slider"></span></label>
        </div>
        <div class="divider"></div>
        <div class="toggle-row">
          <div class="toggle-text">
            Keep Screen On
            <small>Prevents screen from sleeping</small>
          </div>
          <label class="toggle"><input type="checkbox" id="tog-wakelock" checked onchange="handleWakelock(this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>

    </div><!-- /panel-audio -->

    <!-- SESSION PANEL (managed separately, outside scroll-area below) -->

  </div><!-- /scroll-area -->

  <!-- SESSION PANEL ‚Äî full height, outside scroll -->
  <div id="panel-session" class="panel">

    <!-- PRE START -->
    <div id="pre-start">
      <div class="pre-title">Ready to Breathe?</div>

      <div class="summary-grid">
        <div class="sum-box">
          <span class="sum-val" id="sum-breaths">30</span>
          <span class="sum-lbl">Breaths</span>
        </div>
        <div class="sum-box">
          <span class="sum-val" id="sum-rounds">3</span>
          <span class="sum-lbl">Rounds</span>
        </div>
        <div class="sum-box">
          <span class="sum-val" id="sum-hold">90s</span>
          <span class="sum-lbl">Hold</span>
        </div>
      </div>

      <div class="warning-box">
        <p>‚ö†Ô∏è Never practice while driving, swimming, or in water. You may feel lightheaded ‚Äî this is normal. Always practice in a safe position.</p>
      </div>

      <div class="round-dots" id="pre-dots"></div>

      <button class="start-btn" onclick="startSession()">Begin Session</button>
    </div>

    <!-- ACTIVE SESSION -->
    <div id="active-session">

      <div class="phase-track">
        <div class="phase-seg active-phase" id="ps-breathing">Breathing</div>
        <div class="phase-seg" id="ps-hold">Hold</div>
        <div class="phase-seg" id="ps-recovery">Recovery</div>
        <div class="phase-seg" id="ps-transition">Transition</div>
      </div>

      <div id="session-anim-wrap" style="display:contents">
        <div class="circle-wrap" id="circle-wrap">
          <svg viewBox="0 0 240 240">
            <circle class="ring-bg" cx="120" cy="120" r="110"/>
            <circle class="ring-fg" id="ring-fg" cx="120" cy="120" r="110"
              style="stroke-dasharray:691;stroke-dashoffset:0"/>
          </svg>
          <div class="circle-inner">
            <div class="ci-phase" id="ci-phase">ROUND 1</div>
            <div class="ci-main" id="ci-main">30</div>
            <div class="ci-sub" id="ci-sub">BREATHS</div>
          </div>
        </div>
      </div>

      <div class="status-row">
        <div class="stat-item">
          <span class="stat-num" id="st-round">1</span>
          <span class="stat-lbl">Round</span>
        </div>
        <div class="stat-item">
          <span class="stat-num" id="st-breath">‚Äî</span>
          <span class="stat-lbl">Breath</span>
        </div>
        <div class="stat-item">
          <span class="stat-num" id="st-time">0:00</span>
          <span class="stat-lbl">Elapsed</span>
        </div>
      </div>

      <div class="round-dots" id="sess-dots"></div>

      <div class="session-btns">
        <button class="sess-btn sess-pause" id="btn-pause" onclick="togglePause()">Pause</button>
        <button class="sess-btn sess-stop" onclick="stopSession()">Stop</button>
        <button class="sess-btn sess-blank" onclick="showBlank()">‚ñ† Blank</button>
      </div>
    </div>

    <!-- COMPLETE -->
    <div id="complete-screen">
      <div class="complete-title">Done</div>
      <div class="complete-sub">Session complete. Well done.</div>
      <div class="complete-stats">
        <div class="cstat"><span class="cstat-num" id="cp-rounds">3</span><span class="cstat-lbl">Rounds</span></div>
        <div class="cstat"><span class="cstat-num" id="cp-time">0:00</span><span class="cstat-lbl">Time</span></div>
        <div class="cstat"><span class="cstat-num" id="cp-hold">90s</span><span class="cstat-lbl">Max Hold</span></div>
      </div>
      <button class="start-btn" onclick="resetSession()">New Session</button>
    </div>

  </div><!-- /panel-session -->

  <!-- BOTTOM NAV -->
  <div id="bottom-nav">
    <button class="nav-btn active" id="nav-settings" onclick="showPanel('settings')">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span class="nav-label">Settings</span>
    </button>
    <button class="nav-btn" id="nav-audio" onclick="showPanel('audio')">
      <span class="nav-icon">üîä</span>
      <span class="nav-label">Audio</span>
    </button>
    <button class="nav-btn" id="nav-session" onclick="showPanel('session')">
      <span class="nav-icon">ü´Å</span>
      <span class="nav-label">Session</span>
    </button>
  </div>

</div><!-- /app -->

<script>
'use strict';

// ============================================================
// STATE
// ============================================================
const S = {
  breaths: 30, rounds: 3, retention: 90,
  retentionInc: 0, recovery: 15, transition: 10,
  pace: 'regular', metroSound: 'click', breathSound: 'ocean'
};

const LIMITS = {
  breaths:      [10, 80, 5],
  rounds:       [1, 10, 1],
  retention:    [15, 300, 15],
  retentionInc: [0, 60, 5],
  recovery:     [5, 60, 5],
  transition:   [0, 60, 5],
};

const PACE = {
  slower:  { in: 2800, out: 2200, label: '2.8s inhale ¬∑ 2.2s exhale' },
  regular: { in: 2000, out: 1500, label: '2.0s inhale ¬∑ 1.5s exhale' },
  faster:  { in: 1200, out: 1000, label: '1.2s inhale ¬∑ 1.0s exhale' },
};

// ============================================================
// WAKELOCK
// ============================================================
let wakeLock = null;

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch(e) { /* not supported or permission denied */ }
}

async function releaseWakeLock() {
  if (wakeLock) { try { await wakeLock.release(); } catch(e){} wakeLock = null; }
}

function handleWakelock(on) {
  if (on) requestWakeLock(); else releaseWakeLock();
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && document.getElementById('tog-wakelock').checked) {
    requestWakeLock();
  }
});

// ============================================================
// AUDIO
// ============================================================
let actx = null;
function getCtx() {
  if (!actx) actx = new (window.AudioContext || window.webkitAudioContext)();
  if (actx.state === 'suspended') actx.resume();
  return actx;
}

function tone(freq, dur, type='sine', vol=0.3, attack=0.01, release=0.1) {
  const ctx = getCtx();
  const osc = ctx.createOscillator();
  const g = ctx.createGain();
  osc.connect(g); g.connect(ctx.destination);
  osc.type = type; osc.frequency.value = freq;
  const t = ctx.currentTime;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + attack);
  g.gain.setValueAtTime(vol, t + dur - release);
  g.gain.linearRampToValueAtTime(0, t + dur);
  osc.start(t); osc.stop(t + dur);
}

function noise(filterFreqStart, filterFreqEnd, Q, vol, dur, filterType='bandpass') {
  const ctx = getCtx();
  const bufLen = Math.floor(ctx.sampleRate * dur);
  const buf = ctx.createBuffer(1, bufLen, ctx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i=0; i<bufLen; i++) d[i] = Math.random()*2-1;
  const src = ctx.createBufferSource();
  const f = ctx.createBiquadFilter();
  const g = ctx.createGain();
  f.type = filterType; f.Q.value = Q;
  const t = ctx.currentTime;
  f.frequency.setValueAtTime(filterFreqStart, t);
  f.frequency.linearRampToValueAtTime(filterFreqEnd, t + dur);
  src.buffer = buf;
  src.connect(f); f.connect(g); g.connect(ctx.destination);
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + dur*0.2);
  g.gain.linearRampToValueAtTime(0, t + dur);
  src.start(t); src.stop(t + dur);
}

function playMetro() {
  if (!document.getElementById('tog-metro').checked) return;
  const ctx = getCtx();
  if (S.metroSound === 'click') {
    const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate*0.04), ctx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i=0; i<d.length; i++) d[i] = Math.random()*2-1;
    const src = ctx.createBufferSource();
    const f = ctx.createBiquadFilter();
    const g = ctx.createGain();
    f.type='highpass'; f.frequency.value=1800;
    src.buffer=buf; src.connect(f); f.connect(g); g.connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.04);
    src.start();
  } else if (S.metroSound === 'heartbeat') {
    tone(65, 0.08, 'sine', 0.55, 0.005, 0.04);
    setTimeout(()=>tone(58, 0.08, 'sine', 0.4, 0.005, 0.04), 120);
  } else {
    tone(440, 0.12, 'sine', 0.12, 0.04, 0.06);
  }
}

function playBell() {
  const ctx = getCtx(); const t = ctx.currentTime;
  const osc = ctx.createOscillator(); const g = ctx.createGain();
  osc.connect(g); g.connect(ctx.destination);
  osc.type = 'triangle'; osc.frequency.setValueAtTime(880, t);
  osc.frequency.exponentialRampToValueAtTime(660, t+1.8);
  g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.001, t+2.2);
  osc.start(t); osc.stop(t+2.2);
}

function playCompletion() {
  tone(528, 1, 'sine', 0.3, 0.1, 0.4);
  setTimeout(()=>tone(660, 0.8, 'sine', 0.2, 0.05, 0.4), 400);
  setTimeout(()=>tone(792, 1.2, 'sine', 0.25, 0.05, 0.6), 800);
}

function playInhale(durMs) {
  if (!document.getElementById('tog-breath').checked) return;
  const d = durMs/1000;
  if (S.breathSound === 'ocean') noise(280, 750, 2, 0.12, d);
  else if (S.breathSound === 'wind') noise(600, 1400, 0.6, 0.1, d);
  else noise(1800, 3200, 6, 0.08, d);
}

function playExhale(durMs) {
  if (!document.getElementById('tog-breath').checked) return;
  const d = durMs/1000;
  if (S.breathSound === 'ocean') noise(700, 250, 2, 0.1, d);
  else if (S.breathSound === 'wind') noise(1200, 600, 0.6, 0.08, d);
  else noise(3000, 1400, 6, 0.07, d);
}

function speak(text) {
  if (!document.getElementById('tog-voice').checked) return;
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.82; u.volume = 0.95;
  window.speechSynthesis.speak(u);
}

// ============================================================
// SETTINGS LOGIC
// ============================================================
function setVal(k, v) {
  const [mn,mx] = LIMITS[k];
  S[k] = Math.max(mn, Math.min(mx, v));
  const el = document.getElementById('val-'+k);
  if (el) el.textContent = S[k];
  syncSummary();
}

function adj(k, d) { setVal(k, S[k]+d); }

function quickSet(k, v) {
  setVal(k, v);
  // Highlight chip
  document.querySelectorAll(`.chip[onclick*="quickSet('${k}"]`).forEach(c => {
    c.classList.toggle('active', parseInt(c.textContent) === v || c.getAttribute('onclick').includes(','+v+')'));
  });
}

function setPace(p) {
  S.pace = p;
  ['slower','regular','faster'].forEach(x =>
    document.getElementById('pace-'+x).classList.toggle('active', x===p));
  document.getElementById('pace-detail').textContent = PACE[p].label;
}

function setMetroSound(t) {
  S.metroSound = t;
  ['click','heartbeat','soft'].forEach(x =>
    document.getElementById('ms-'+x).classList.toggle('active', x===t));
  playMetro(); // preview
}

function setBreathSound(t) {
  S.breathSound = t;
  ['ocean','wind','nose'].forEach(x =>
    document.getElementById('bs-'+x).classList.toggle('active', x===t));
}

function syncSummary() {
  const el = id => document.getElementById(id);
  el('sum-breaths').textContent = S.breaths;
  el('sum-rounds').textContent = S.rounds;
  el('sum-hold').textContent = S.retention + 's';
  buildDots('pre-dots', S.rounds);
}

function buildDots(containerId, count, current=-1) {
  const c = document.getElementById(containerId);
  if (!c) return;
  c.innerHTML = '';
  for (let i=0; i<count; i++) {
    const d = document.createElement('div');
    d.className = 'r-dot' + (i < current ? ' done' : i === current ? ' curr' : '');
    d.id = containerId + '-' + i;
    c.appendChild(d);
  }
}

function updateDot(containerId, idx, cls) {
  const d = document.getElementById(containerId + '-' + idx);
  if (d) { d.className = 'r-dot ' + cls; }
}

// ============================================================
// PANEL NAVIGATION
// ============================================================
function showPanel(name) {
  ['settings','audio','session'].forEach(n => {
    const panel = document.getElementById('panel-'+n);
    const navBtn = document.getElementById('nav-'+n);
    const isSession = n === 'session';
    if (n === name) {
      if (isSession) {
        panel.style.display = 'flex';
        document.getElementById('scroll-area').style.display = 'none';
      } else {
        panel.classList.add('active');
        document.getElementById('scroll-area').style.display = '';
      }
      navBtn.classList.add('active');
    } else {
      if (isSession) panel.style.display = 'none';
      else panel.classList.remove('active');
      navBtn.classList.remove('active');
    }
  });

  // Hide all non-session panels from scroll-area when on session
  ['settings','audio'].forEach(n => {
    document.getElementById('panel-'+n).style.display = name === 'session' ? 'none' : '';
  });
  if (name !== 'session') {
    document.getElementById('panel-'+name).classList.add('active');
  }
}

// ============================================================
// SESSION ENGINE
// ============================================================
let sess = {
  running: false, paused: false,
  round: 0, phase: null,
  sessionStart: 0, maxHold: 0,
  elapsedTimer: null,
  currentTimer: null,
};

function startSession() {
  getCtx(); // unlock audio on iOS/Android
  if (document.getElementById('tog-wakelock').checked) requestWakeLock();

  sess = {
    running: true, paused: false,
    round: 0, phase: null,
    sessionStart: Date.now(), maxHold: 0,
    elapsedTimer: null, currentTimer: null,
  };

  document.getElementById('pre-start').style.display = 'none';
  document.getElementById('active-session').style.display = 'flex';
  document.getElementById('active-session').style.flexDirection = 'column';
  document.getElementById('active-session').style.alignItems = 'center';
  document.getElementById('active-session').style.gap = '12px';
  document.getElementById('complete-screen').style.display = 'none';

  buildDots('sess-dots', S.rounds);

  sess.elapsedTimer = setInterval(() => {
    if (sess.paused) return;
    const e = Math.floor((Date.now() - sess.sessionStart)/1000);
    document.getElementById('st-time').textContent = fmtTime(e);
  }, 1000);

  startRound(0);
}

function fmtTime(s) {
  return Math.floor(s/60) + ':' + String(s%60).padStart(2,'0');
}

function setPhase(ph) {
  ['breathing','hold','recovery','transition'].forEach(p =>
    document.getElementById('ps-'+p).classList.toggle('active-phase', p===ph));
}

function setCircle(phase, main, sub, progress, color='cold') {
  document.getElementById('ci-phase').textContent = phase;
  document.getElementById('ci-main').textContent = main;
  document.getElementById('ci-sub').textContent = sub;
  const circ = 691;
  document.getElementById('ring-fg').style.strokeDashoffset = circ*(1-Math.max(0,Math.min(1,progress)));
  document.getElementById('ring-fg').style.stroke = color==='warm' ? 'var(--warm)' : 'var(--accent)';
}

function animClass(cls) {
  const w = document.getElementById('session-anim-wrap') || document.getElementById('active-session');
  ['anim-inhale','anim-exhale','anim-hold'].forEach(c => w.classList.remove(c));
  if (cls) {
    void w.offsetWidth; // reflow
    w.classList.add(cls);
  }
}

// --- BREATHING PHASE ---
function startRound(r) {
  if (!sess.running) return;
  sess.round = r;
  document.getElementById('st-round').textContent = r+1;
  updateDot('sess-dots', r, 'curr');
  setPhase('breathing');
  doBreathing(r);
}

function doBreathing(r) {
  if (!sess.running) return;
  const total = S.breaths;
  let n = 0;
  const pace = PACE[S.pace];
  let said10 = false, said3 = false;

  const nextBreath = () => {
    if (!sess.running) return;
    if (sess.paused) { setTimeout(nextBreath, 150); return; }

    if (n >= total) { doHold(r); return; }

    const remaining = total - n;
    document.getElementById('st-breath').textContent = n+1;
    setCircle('ROUND ' + (r+1), remaining, 'BREATHS LEFT', remaining/total, 'cold');

    // Voice
    if (remaining === 10 && !said10 && document.getElementById('voice-10').checked) {
      speak('Last 10 breaths'); said10 = true;
    }
    if (remaining === 3 && !said3 && document.getElementById('voice-3').checked) {
      speak('Last 3 breaths'); said3 = true;
    }

    // Inhale
    animClass('anim-inhale');
    document.getElementById('ci-phase').textContent = 'INHALE';
    playMetro();
    playInhale(pace.in);

    sess.currentTimer = setTimeout(() => {
      if (!sess.running) return;
      // Exhale
      animClass('anim-exhale');
      document.getElementById('ci-phase').textContent = 'EXHALE';
      playExhale(pace.out);

      sess.currentTimer = setTimeout(() => {
        n++;
        nextBreath();
      }, pace.out);
    }, pace.in);
  };

  nextBreath();
}

// --- HOLD PHASE ---
function doHold(r) {
  if (!sess.running) return;
  setPhase('hold');
  animClass('anim-hold');

  const retDur = S.retention + S.retentionInc * r;
  if (retDur > sess.maxHold) sess.maxHold = retDur;

  if (document.getElementById('voice-hold').checked) speak('Start breath hold');
  playBell();

  let elapsed = 0;
  const bells = [];
  if (document.getElementById('bell-15').checked) bells.push(15);
  if (document.getElementById('bell-30').checked) bells.push(30);
  if (document.getElementById('bell-60').checked) bells.push(60);
  if (document.getElementById('bell-90').checked) bells.push(90);
  const announced = new Set();

  const tick = setInterval(() => {
    if (!sess.running) { clearInterval(tick); return; }
    if (sess.paused) return;

    elapsed++;
    const rem = retDur - elapsed;
    setCircle('BREATH HOLD', rem, 'HOLD', rem/retDur, 'warm');
    document.getElementById('st-breath').textContent = '‚Äî';

    if (document.getElementById('tog-bell').checked) {
      bells.forEach(iv => {
        if (elapsed > 0 && elapsed % iv === 0 && !announced.has(elapsed)) {
          announced.add(elapsed);
          playBell();
          speak(elapsed + ' seconds');
        }
      });
    }

    if (elapsed >= retDur) {
      clearInterval(tick);
      doRecovery(r);
    }
  }, 1000);
}

// --- RECOVERY PHASE ---
function doRecovery(r) {
  if (!sess.running) return;
  setPhase('recovery');
  animClass('');
  playBell();
  if (document.getElementById('voice-rec').checked) speak('Recovery hold. Breathe in and hold.');

  let elapsed = 0;
  const total = S.recovery;

  const tick = setInterval(() => {
    if (!sess.running) { clearInterval(tick); return; }
    if (sess.paused) return;

    elapsed++;
    const rem = total - elapsed;
    setCircle('RECOVERY HOLD', rem, 'HOLD YOUR BREATH', rem/total, 'cold');

    if (elapsed >= total) {
      clearInterval(tick);
      updateDot('sess-dots', r, 'done');
      if (r + 1 >= S.rounds) endSession();
      else doTransition(r+1);
    }
  }, 1000);
}

// --- TRANSITION PHASE ---
function doTransition(nextR) {
  if (!sess.running) return;
  setPhase('transition');

  if (S.transition === 0) { startRound(nextR); return; }

  let elapsed = 0;
  const total = S.transition;

  const tick = setInterval(() => {
    if (!sess.running) { clearInterval(tick); return; }
    if (sess.paused) return;

    elapsed++;
    const rem = total - elapsed;
    setCircle('ROUND ' + (nextR+1) + ' IN', rem, 'BREATHE NORMALLY', rem/total, 'cold');

    if (elapsed >= total) {
      clearInterval(tick);
      startRound(nextR);
    }
  }, 1000);
}

// --- END ---
function endSession() {
  sess.running = false;
  clearInterval(sess.elapsedTimer);
  releaseWakeLock();

  const totalSec = Math.floor((Date.now() - sess.sessionStart)/1000);
  document.getElementById('cp-rounds').textContent = S.rounds;
  document.getElementById('cp-time').textContent = fmtTime(totalSec);
  document.getElementById('cp-hold').textContent = sess.maxHold + 's';

  document.getElementById('active-session').style.display = 'none';
  document.getElementById('complete-screen').style.display = 'flex';
  document.getElementById('complete-screen').style.flexDirection = 'column';
  document.getElementById('complete-screen').style.alignItems = 'center';

  playCompletion();
  speak('Session complete. Well done.');
}

function togglePause() {
  sess.paused = !sess.paused;
  document.getElementById('btn-pause').textContent = sess.paused ? 'Resume' : 'Pause';
}

function stopSession() {
  sess.running = false;
  clearInterval(sess.elapsedTimer);
  releaseWakeLock();
  resetSession();
}

function resetSession() {
  sess.running = false;
  document.getElementById('pre-start').style.display = 'flex';
  document.getElementById('pre-start').style.flexDirection = 'column';
  document.getElementById('pre-start').style.alignItems = 'center';
  document.getElementById('active-session').style.display = 'none';
  document.getElementById('complete-screen').style.display = 'none';
  syncSummary();
}

// ============================================================
// BLANK SCREEN
// ============================================================
function showBlank() {
  document.getElementById('blank-overlay').classList.add('show');
}
function hideBlank() {
  document.getElementById('blank-overlay').classList.remove('show');
  document.getElementById('tog-blank').checked = false;
}

// ============================================================
// PWA INSTALL
// ============================================================
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('install-banner').classList.add('show');
});

document.getElementById('install-btn').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const result = await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById('install-banner').classList.remove('show');
});

window.addEventListener('appinstalled', () => {
  document.getElementById('install-banner').classList.remove('show');
});

// ============================================================
// SERVICE WORKER
// ============================================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// ============================================================
// DEEP LINK
// ============================================================
if (location.hash === '#session') showPanel('session');

// ============================================================
// STREAK TRACKER
// ============================================================
const STREAK_START = '2025-10-31';
const STREAK_KEY   = 'wh_streak_lastLogged_v2';
const STREAK_COUNT_KEY = 'wh_streak_count_v2';

function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' +
    String(d.getMonth()+1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

function daysBetween(a, b) {
  return Math.round((new Date(b) - new Date(a)) / 86400000);
}

function formatStreakDate(str) {
  const [y,m,d] = str.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[parseInt(m)-1] + ' ' + parseInt(d) + ', ' + y;
}

function loadStreak() {
  const lastLogged = localStorage.getItem(STREAK_KEY);
  const savedCount = parseInt(localStorage.getItem(STREAK_COUNT_KEY) || '0');
  const today = todayStr();

  if (!lastLogged) {
    const count = daysBetween(STREAK_START, today) + 1;
    localStorage.setItem(STREAK_KEY, today);
    localStorage.setItem(STREAK_COUNT_KEY, count);
    return { count, broken: false, loggedToday: true };
  }

  const diff = daysBetween(lastLogged, today);
  if (diff === 0) return { count: savedCount, broken: false, loggedToday: true };
  if (diff === 1) return { count: savedCount, broken: false, loggedToday: false };
  return { count: 0, broken: true, loggedToday: false };
}

function logToday() {
  const today = todayStr();
  const current = loadStreak();
  if (current.loggedToday && !current.broken) return current;
  const newCount = current.broken ? 1 : current.count + 1;
  localStorage.setItem(STREAK_KEY, today);
  localStorage.setItem(STREAK_COUNT_KEY, newCount);
  return { count: newCount, broken: false, loggedToday: true };
}

function logTodayManual() {
  const result = logToday();
  renderStreak(result);
}

function renderStreak(state) {
  const banner  = document.getElementById('streak-banner');
  const countEl = document.getElementById('streak-count');
  const btn     = document.getElementById('streak-log-btn');
  const sinceEl = document.getElementById('streak-since-date');
  const flame   = document.getElementById('streak-flame');

  countEl.innerHTML = (state.broken ? 0 : state.count) + '<span>days</span>';

  if (state.broken) {
    banner.classList.add('streak-broken');
    flame.textContent = '\u{1F4A7}';
    sinceEl.textContent = 'Streak broken';
    btn.textContent = 'Restart';
    btn.classList.remove('logged');
  } else {
    banner.classList.remove('streak-broken');
    flame.textContent = '\u{1F525}';
    sinceEl.textContent = formatStreakDate(STREAK_START);
    if (state.loggedToday) {
      btn.textContent = '\u2713 Logged';
      btn.classList.add('logged');
    } else {
      btn.textContent = 'Log Today';
      btn.classList.remove('logged');
    }
  }
}

function initStreak() {
  renderStreak(loadStreak());
}

// Wrap endSession to auto-log on completion
const _endSessionOrig = endSession;
endSession = function() {
  _endSessionOrig();
  renderStreak(logToday());
};

// ============================================================
// INIT
// ============================================================
syncSummary();
requestWakeLock();
initStreak();

// Prevent default touch behaviors
document.addEventListener('touchmove', e => {
  if (e.target.closest('#scroll-area')) return;
  e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
